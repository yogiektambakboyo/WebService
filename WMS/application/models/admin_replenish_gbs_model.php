<?phpclass Admin_Replenish_Gbs_Model extends CI_Model{	public function getMstTransfer()	{		// $sql = "select KodeNota,Tgl,Sales,Keterangan from mastertransfer where tgl >= '20130101' order by KodeNota";		$sql = "  select distinct m.KodeNota,m.Tgl,m.Sales,m.Keterangan, d.tujuanGudang, d.asalGudang 				  from mastertransfer m,detailtransfer d--, wms.mastertaskrpl e				  where m.kodeNota = d.kodeNota and d.tujuangudang in (select kode from wms.gudangwms)				  and d.asalGudang in (select kode from wms.gudangwms) and m.tgl >='20120101' and m.KodeNota not in (select ERPCOde from wms.mastertaskrpl where ERPCode <> null and isFinish=0 and isCancel=0 and isFinishMove=0)				  order by m.KodeNota				  "; 		$result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        return $result;	}		public function getDtlTransfer($kodeNota)	{		$sql = "select a.kodeNota,a.brg,a.jml,dbo.KonversiSatuanToText(a.brg,a.jml) as jmlKonv,b.keterangan as namaBarang,a.tujuanGudang,a.AsalGudang, c.keterangan as namaGudangTjn,				d.keterangan as nmAsalGudang 				from detailtransfer a				left join barang b				on a.brg=b.kode				left join gudang c				on a.tujuanGudang = c.kode 				left join gudang d				on a.asalGudang = d.kode				where a.kodeNota = '".$kodeNota."' ";		$result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        return $result;	}		public function getSuggestion($brg,$jml,$gudang)	{		$sql 	= "select top 1 r.Name,r.RackLevel,bs.ExpDate,sum(Qty) as Qty,dbo.KonversiSatuanToText('".$brg."',sum(Qty)) as QtyKonv					, b.binCode, b.rackSlotCode from wms.Bin b,wms.BinSKU bs,wms.RackSlot r					where bs.SKUCode='".$brg."' and b.BinCode=bs.BinCode and b.WHCode='".$gudang."' and b.IsOnAisle=0					and r.RackSlotCode=b.RackSlotCode and bs.Qty>=".$jml."					group by r.Name,r.RackLevel,bs.ExpDate,b.BinCode, b.RackSlotCode";		// echo $sql;		$result = $this->db->conn_id->prepare($sql);		$result->execute();		$result = $result->fetchAll();		return $result;	}		public function getsatuan($kodeNota) 	{		$sql = "select distinct a.brg,b.Rasio, b.Satuan				from detailtransfer a				left join satuan b				on a.brg=b.brg				where a.kodeNota = '".$kodeNota."' and b.satuanaktif=1 ";					// echo $sql;        $result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        return $result;    }		public function satuan($brg,$jml)	{		$sql 	= "select '".$brg."' as barang ,'".$jml."' as jml,dbo.KonversiSatuanToText('".$brg."','".$jml."') as QtyKonv";		// echo $sql;		$result = $this->db->conn_id->prepare($sql);		$result->execute();		$result = $result->fetchAll();		return $result;	}		function getTransactionCode() {        $sql = "select count(*) as jumlah from wms.MasterTaskRpl";        $result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        $kode = '10/' . date('y') . '/L/';        for ($i = 0; $i < (6 - strlen(((String) $result[0]['jumlah']+1))); $i++) {            $kode.='0';        }        $kode.=(String) ($result[0]['jumlah']+1);        return $kode;    }    function setMasterTaskRpl($TransactionCode,$ERPCode,$WHSrc,$WHDest, $OperatorCode) {        $sql = "insert into wms.MasterTaskRpl(TransactionCode,ProjectCode,ERPCode,WHCodeSrc,WHCodeDest,TransactionDate,CreateUserId,CreateTime)                values('" . $TransactionCode . "','RPL','".$ERPCode."','".$WHSrc."','".$WHDest."',getdate(),'" . $OperatorCode . "',getdate())";                        $result = $this->db->conn_id->prepare($sql);        if ($result->execute()) {            return true;        }        return false;    }		function setDetailTaskRplmanual($TransactionCode, $NoUrut, $BinCode, $SKUCode, $QtyNeed, $SrcRackSlot, $DestRackSlot) {                $sql = "select ExpDate from wms.BinSKU where SKUCode='" . $SKUCode . "' and BinCode='" . $BinCode . "'";        $result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        //qtyneednow -> yang diambil operator		//qtyneedstar->qty admin        $sql = "insert into wms.DetailTaskRpl(TransactionCode,NoUrut,BinCode,SKUCode,ExpDate,QtyNeedStart,QtyNeedNow,SrcRackSlot,DestRackSlot,CreateTime)                values('" . $TransactionCode . "','" . $NoUrut . "','" . $BinCode . "','" . $SKUCode . "','".$result[0]['ExpDate']."','" . $QtyNeed . "','" . $QtyNeed . "','" . $SrcRackSlot . "','" . $DestRackSlot . "',getdate())";								// echo $sql;                $result = $this->db->conn_id->prepare($sql);        if ($result->execute()) {            return true;        }        return false;    }		function deleteDetailTaskDerp($transactionCode, $SKUCode)	{		$sql = "delete from wms.DetailTaskDERP where transactionCode ='".$transactionCode."' and skuCode = '".$SKUCode."' ";		$result = $this->db->conn_id->prepare($sql);		if ($result->execute()) {            return true;        }        return false;			}	    function setDetailTaskDERP($TransactionCode,$SKUCode,$Qty)    {        $sql = "select Satuan from Satuan where Rasio=1 and SatuanAktif=1 and Brg='" . $SKUCode . "'";        $result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();                $sql = "insert into wms.DetailTaskDERP(TransactionCode,SKUCode,Qty,Ratio,RatioName)                values('" . $TransactionCode . "','" . $SKUCode . "',".$Qty.",'1','".$result[0]['Satuan']."')";								// echo $sql;                $result = $this->db->conn_id->prepare($sql);        if ($result->execute()) {            return true;        }        return false;    }		function cekRackSlotUse($rackSlot, $sku)	{			//cek rackslot 		$sql = "select rackslotcode,name,skucode from wms.rackslot where rackslotcode='".$rackSlot."' ";		$result = $this->db->conn_id->prepare($sql);		$result->execute();		$result = $result->fetchAll();				$skuCode = $result[0]['skucode'];				if (empty($skuCode)){			return true;		}else{			$sql = "select rackslotcode,name,skucode from wms.rackslot where rackslotcode='".$rackSlot."' and skucode='".$sku."' ";			$result = $this->db->conn_id->prepare($sql);			$result->execute();			$result = $result->fetchAll();			// var_dump($result);			// $data = $result[0];			// echo $sql;			if (empty($result)){				return false;			}else{				return true;			}		}					}		public function getName($rackSlot, $sku)	{		$sql = "select rackslotcode,name,skucode from wms.rackslot where rackslotcode='".$rackSlot."' and skucode='".$sku."' ";		$result = $this->db->conn_id->prepare($sql);		$result->execute();		$result = $result->fetchAll();		return $result;	}		function cekBin($kodeBin)    {        $sql    = "SELECT COUNT (*) AS Jumlah FROM wms.bin WHERE binCode='".$kodeBin."'";                $result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        $jumlah = 0;        foreach($result as $row){            $jumlah = $row['Jumlah'];        }        return $jumlah;    }		function cekRack($rack)    {        $sql    = "SELECT COUNT (*) AS Jumlah FROM wms.rackSlot WHERE rackslotcode='".$rack."'";                $result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        $jumlah = 0;        foreach($result as $row){            $jumlah = $row['Jumlah'];        }        return $jumlah;    }		function cekWHSKURack($SrcRack, $DestRack, $BinCode, $SKUCode) {        $sql = "select count(*) as jumlah from wms.Bin bi inner join wms.BinSKU bs on bi.BinCode=bs.BinCode where bi.RackSlotCode='" . $DestRack . "' and bs.Qty>0";        $result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        if ($result[0]['jumlah'] > 0) {//destination Rack kosong            $sql = "select count(*) as jumlah from wms.RackSlot where RackSlotCode='" . $DestRack . "' and multiplebin=1";            $result = $this->db->conn_id->prepare($sql);            $result->execute();            $result = $result->fetchAll();            if ($result[0]['jumlah'] > 0) {//cek multiplebin                //if(cekWHRack($SrcRack, $DestRack))//cek gudang                //{                return array('status' => true);                //}                //return array('status'=>false,'msg'=>'Gudang Beda');            } else {                //if(cekWHRack($SrcRack, $DestRack))//cek gudang                //{                $sql = "select count(*) as jumlah from wms.Bin bi                            inner join wms.BinSKU bs                            on bi.BinCode=bs.BInCode                            where bs.SKUCode='" . $SKUCode . "' and                             bs.BinCode<>'" . $BinCode . "'                            and bs.ExpDate=(select ExpDate from wms.BinSKU where BinCode='" . $BinCode . "' and SKUCode='" . $SKUCode . "')";                $result = $this->db->conn_id->prepare($sql);                $result->execute();                $result = $result->fetchAll();                if ($result[0]['jumlah'] > 0) {//cek SKU dan ED                    return array('status' => true);                }                return array('status' => false, 'msg' => 'SKU atau ED beda');                //}                //return array('status'=>false,'msg'=>'Gudang Beda');            }        }        return array('status' => true);    }		function cekRackSlotName() {        $sql = "select RackSlotCode,Name from wms.RackSlot";        $result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();	// echo $sql;        return $result;    }		function getRackSlot() {        $sql = "select Name from wms.RackSlot";        $result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        return $result;    }}