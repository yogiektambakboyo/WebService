<?php class admin_picklist_retur_model extends CI_Model{	public function getPicklist_retur($cabang)	{		$tgl	= date('Ymd');		$sql = "select 'Retur' as Jenis,m.Kodenota,m.Tgl,p.Perusahaan,g.Kode,g.Keterangan as Gudang,count(d.brg) 				as SKU,sum(d.jml*(d.hrgsatuan-d.disc))*-1.1 as Total,m.NoPicklist,m.TglPicklist				from masterjual m,detailjual d,pelanggan p,gudang g				where m.kodenota like '".$cabang."'+'%' and m.tgl>='20130507' and m.total<0				and p.kode=m.shipto and d.kodenota=m.kodenota and d.gudang=g.kode and d.jml<>0				and (m.nopicklist is null or m.nopicklist='null' or rtrim(ltrim(m.nopicklist))='' or m.nopicklist='')				group by m.Kodenota,m.Tgl,p.Perusahaan,g.Keterangan,m.NoPicklist,m.TglPicklist,g.Kode				union all				select 'Tolakan',m.Kodenota,m.Tgl,p.Perusahaan,g.Kode,g.Keterangan,count(m.Brg),sum(m.Total)*1.1,m.NoPicklist,m.TglPicklist				from bcp_tolakandms m,pelanggan p,gudang g,masterjual mj,detailjual dj				where m.Kodenota like '".$cabang."'+'%' and m.tgl>='20130507' and m.total>0				and mj.kodenota=m.kodeinvoice and dj.kodenota=m.kodeinvoice and dj.brg=m.brg				and p.kode=mj.shipto and g.kode=dj.gudang				and (m.nopicklist is null or m.nopicklist='null' or rtrim(ltrim(m.nopicklist))='' or m.nopicklist='')				group by m.Kodenota,m.Tgl,p.Perusahaan,g.Keterangan,m.NoPicklist,m.TglPicklist,g.Kode				union all				select 'noTransaksi',wms.fnGetNoPicklistRetur ('".$cabang."', '".$tgl."') as noTransaksi,'','','','','','','',''				order by NoPicklist desc,Jenis,Perusahaan,Tgl";								// echo ($sql);		$result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        return $result;	}		public function getCabang($session)	{		$sql = "select Cabang,NamaCabang from kategori where tgltransaksi>getdate()-".$session;						$result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();		// var_dump($this->session->userdata('HariCabang'));        return $result;	}		public function getCabangEditList($cabang, $session)	{		$sql = "select Cabang,NamaCabang from kategori where tgltransaksi>getdate()-".$session." and Cabang = '".$cabang."'";						$result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        return $result[0]['NamaCabang'];	}		public function getNoPicklist($cabang)	{		$tgl	= date('Ymd');		$sql 	= "select wms.fnGetNoPicklistRetur ('".$cabang."','".$tgl."')";		$cek	= $this->db->conn_id->prepare($sql);		$cek->execute();		$noPicklist = $cek->fetchAll();		// var_dump($noPicklist);				// $thn		= date('Y');		// $db			= $noPicklist[0]['noPickList'];		// $explode	= explode('/',$db);		// $thnDb		= $explode[3]; 				// if (empty($noPicklist[0]['noPickList']) OR $thn !== $thnDb){			// $noProgram	= '000001';		// }else {			// $db			= $noPicklist[0]['noPickList'];			// $explode	= explode('/',$db);			// $no			= $explode[4]; 			// $convert 	= intval($no) + 1;  						// $digit   	= 6;            // $counter 	= $convert;                        // $str 		= str_repeat('0', $digit) . $counter;            // $noProgram 	= substr($str, strlen($str) - $digit);			// var_dump($noProgram);           		// }				// $noFix		= $cabang.'/PR/'.$thn.'/'.$noProgram;				//var_dump($noFix);		// var_dump();		return $noPicklist[0]["computed"];	}		public function setMasterJual($noPickList, $kodeNota)	{		$date 	= date('Y-m-d');		$sql	= "UPDATE dbo.MasterJual SET NoPickList='" . $noPickList . "', TglPickList='". $date ."' where KodeNota = '" . $kodeNota . "'";		// var_dump($sql);		$update = $this->db->conn_id->prepare($sql);        if ($update->execute()){		// echo 'ok';            return true;        }else {		// echo 'tidak';            return false;        }	}		public function setTolakandms($noPickList, $kodeNota)	{		$date 	= date('Y-m-d');		$sql	= "UPDATE dbo.bcp_tolakandms SET NoPickList='" . $noPickList . "', TglPickList='". $date ."' where KodeNota = '" . $kodeNota . "'";		// var_dump($sql);		$update = $this->db->conn_id->prepare($sql);        if ($update->execute()){		// echo 'ok';            return true;        }else {		// echo 'tidak';            return false;        }	}		public function getListEdit($cabang)	{		// $sql	= "	select 'Retur' as Jenis,m.Kodenota,m.Tgl,p.Perusahaan,g.Kode,g.Keterangan as Gudang,					// count(d.brg) as SKU,sum(d.jml*(d.hrgsatuan-d.disc))*-1.1 as Total,m.NoPicklist,m.TglPicklist					// from masterjual m,detailjual d,pelanggan p,gudang g					// where m.tgl>='20130501' and m.total<0					// and p.kode=m.shipto and d.kodenota=m.kodenota and d.gudang=g.kode and d.jml<>0					// and (m.nopicklist is not null and m.nopicklist <> 'null' and rtrim(ltrim(m.nopicklist)) <> '')					// group by m.Kodenota,m.Tgl,p.Perusahaan,g.Keterangan,m.NoPicklist,m.TglPicklist,g.Kode					// union all					// select 'Tolakan',m.Kodenota,m.Tgl,p.Perusahaan,g.Kode,g.Keterangan,count(m.Brg),sum(m.Total)*1.1,m.NoPicklist,m.TglPicklist					// from bcp_tolakandms m,pelanggan p,gudang g,masterjual mj,detailjual dj					// where m.tgl>='20130501' and m.total>0					// and mj.kodenota=m.kodeinvoice and dj.kodenota=m.kodeinvoice and dj.brg=m.brg					// and p.kode=mj.shipto and g.kode=dj.gudang					// and (m.nopicklist is not null and m.nopicklist <> 'null' and rtrim(ltrim(m.nopicklist))<> '')					// group by m.Kodenota,m.Tgl,p.Perusahaan,g.Keterangan,m.NoPicklist,m.TglPicklist,g.Kode					// order by NoPicklist desc,Jenis,Perusahaan,Tgl";				// $sql	= "	select m.NoPicklist, m.tglPicklist					// from masterjual m,detailjual d,pelanggan p,gudang g, wms.mastertaskrcv ts					// where m.tgl>='20130501' and m.total<0					// and p.kode=m.shipto and d.kodenota=m.kodenota and d.gudang=g.kode and d.jml<>0					// and (m.nopicklist is not null and m.nopicklist <> 'null' and rtrim(ltrim(m.nopicklist)) <> '')					// and ts.ERPCode <> m.NoPicklist					// group by m.NoPicklist, m.tglPicklist";							$sql = "select NoPicklist,tglPicklist,sum(Retur) as Retur,sum(Tolakan) as Tolakan from				(select NoPicklist,TglPicklist,count(kodenota) as Retur,0 Tolakan				from masterjual				where tglpicklist > '20130501' and nopicklist like '".$cabang."'+'/PR/%'				and total<0				group by NoPicklist,TglPicklist				union all				select NoPicklist,TglPicklist,0,count(distinct Kodenota)				from bcp_tolakandms				where nopicklist like '".$cabang."'+'/PR/%'				and total>0				group by NoPicklist,TglPicklist) a				where not exists (select * from wms.MasterTaskRcv where ERPCode=a.NoPicklist)				group by NoPicklist,TglPicklist";					$result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        return $result;					}		public function getKodeGudang($kodeNota)	{		$sql = "select g.Kode				from masterjual m,detailjual d,pelanggan p,gudang g				where m.kodenota = '".$kodeNota."' and m.tgl>='20130501' and m.total<0				and p.kode=m.shipto and d.kodenota=m.kodenota and d.gudang=g.kode and d.jml<>0				group by g.Kode				union all				select g.Kode				from bcp_tolakandms m,pelanggan p,gudang g,masterjual mj,detailjual dj				where m.kodenota = '".$kodeNota."' and m.tgl>='20130501' and m.total>0				and mj.kodenota=m.kodeinvoice and dj.kodenota=m.kodeinvoice and dj.brg=m.brg				and p.kode=mj.shipto and g.kode=dj.gudang				group by g.Kode				";						$result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        return $result;	}		public function getEdit($cabang,$noPicklist)	{			$sql = "select 'Retur' as Jenis,m.Kodenota,m.Tgl,p.Perusahaan,g.Kode,g.Keterangan as Gudang,count(d.brg)					as SKU,sum(d.jml*(d.hrgsatuan-d.disc))*-1.1 as Total,m.NoPicklist,m.TglPicklist					from masterjual m,detailjual d,pelanggan p,gudang g					where m.kodenota like '".$cabang."'+'%' and m.tgl>='20130501' and m.total<0					and p.kode=m.shipto and d.kodenota=m.kodenota and d.gudang=g.kode and d.jml<>0					and (m.nopicklist is null or m.nopicklist='null' or rtrim(ltrim(m.nopicklist))='' or m.nopicklist='".$noPicklist."')					group by m.Kodenota,m.Tgl,p.Perusahaan,g.Keterangan,m.NoPicklist,m.TglPicklist,g.Kode					union all					select 'Tolakan',m.Kodenota,m.Tgl,p.Perusahaan,g.Kode,g.Keterangan,count(m.Brg),sum(m.Total)*1.1,m.NoPicklist,m.TglPicklist					from bcp_tolakandms m,pelanggan p,gudang g,masterjual mj,detailjual dj					where m.kodenota like '".$cabang."'+'%' and m.tgl>='20130501' and m.total>0					and mj.kodenota=m.kodeinvoice and dj.kodenota=m.kodeinvoice and dj.brg=m.brg					and p.kode=mj.shipto and g.kode=dj.gudang					and (m.nopicklist is null or m.nopicklist='null' or rtrim(ltrim(m.nopicklist))='' or m.nopicklist='".$noPicklist."')					group by m.Kodenota,m.Tgl,p.Perusahaan,g.Keterangan,m.NoPicklist,m.TglPicklist,g.Kode					order by NoPicklist desc,Jenis,Perusahaan,Tgl ";		// var_dump($sql);				$result = $this->db->conn_id->prepare($sql);        $result->execute();        $result = $result->fetchAll();        return $result;	}		public function setNullPickList($noPicklist)	{		$sql	= "UPDATE dbo.MasterJual SET NoPickList=NULL, TglPickList=NULL where NoPicklist='".$noPicklist."'";		// var_dump($sql);		$update = $this->db->conn_id->prepare($sql);        if ($update->execute()){            return true;        }else {            return false;        }	}		public function setNullPickListTolakan($noPicklist)	{		$sql	= "UPDATE dbo.bcp_tolakandms SET NoPickList=NULL, TglPickList=NULL where NoPicklist='".$noPicklist."'";		// var_dump($sql);		$update = $this->db->conn_id->prepare($sql);        if ($update->execute()){            return true;        }else {            return false;        }	}}?>